generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  name               String?
  password           String
  image              String?
  rating             Float               @default(0)
  verified           Boolean             @default(false)
  isAdmin            Boolean             @default(false)
  banned             Boolean             @default(false)
  phoneVerified      Boolean             @default(false)
  emailVerified      Boolean             @default(false)
  idVerified         Boolean             @default(false)
  topRatedSeller     Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  favorites          Favorite[]
  listings           Listing[]
  receivedMessages   Message[]           @relation("ReceivedMessages")
  sentMessages       Message[]           @relation("SentMessages")
  reviewsReceived    Review[]            @relation("Reviewee")
  reviewsGiven       Review[]            @relation("Reviewer")
  purchases          Transaction[]       @relation("Buyer")
  sales              Transaction[]       @relation("Seller")
  wallet             Wallet?
  blockedBy          BlockedUser[]       @relation("Blocker")
  blockedUsers       BlockedUser[]       @relation("Blocked")
  reportsSubmitted   Report[]            @relation("Reporter")
  reportsReceived    Report[]            @relation("Reported")
  verificationTokens VerificationToken[]
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Float    @default(0)
  pending   Float    @default(0)
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model Listing {
  id          String  @id @default(cuid())
  title       String
  description String
  price       Float
  images      String
  // Old fields - kept temporarily for migration
  brand       String?
  size        String?
  color       String?
  // New reference relations
  brandId     String?
  sizeId      String?
  colorId     String?
  brandRef    Brand?  @relation(fields: [brandId], references: [id])
  sizeRef     Size?   @relation(fields: [sizeId], references: [id])
  colorRef    Color?  @relation(fields: [colorId], references: [id])

  style            String?
  condition        String
  gender           String?
  category         String?
  itemType         String?
  subtype          String?
  status           String        @default("AVAILABLE")
  moderationStatus String        @default("APPROVED")
  verified         Boolean       @default(false)
  aiConfidence     Float?
  sellerId         String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  favoritedBy      Favorite[]
  seller           User          @relation(fields: [sellerId], references: [id])
  messages         Message[]
  transactions     Transaction[]
  reports          Report[]
}

model Brand {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  category  String? // luxury, designer, streetwear, fast-fashion, moroccan
  verified  Boolean   @default(false)
  popular   Boolean   @default(false)
  logo      String?
  createdAt DateTime  @default(now())
  listings  Listing[]
}

model Color {
  id        String    @id @default(cuid())
  name      String    @unique
  hexCode   String
  category  String // primary, neutral, pastel, vibrant, metallic, pattern
  createdAt DateTime  @default(now())
  listings  Listing[]
}

model Size {
  id        String    @id @default(cuid())
  value     String // e.g., "M", "38", "10"
  system    String // EU, US, UK, INT
  category  String // clothing, shoes, accessories
  gender    String? // men, women, kids, unisex
  itemType  String? // tops, bottoms, dresses, shoes
  sortOrder Int       @default(0)
  createdAt DateTime  @default(now())
  listings  Listing[]

  @@unique([value, system, category, gender, itemType])
}

model Transaction {
  id        String @id @default(cuid())
  buyerId   String
  sellerId  String
  listingId String
  amount    Float
  fee       Float
  netAmount Float
  status    String @default("PENDING")

  // Shipping information
  shippingMethod  String? // 'AMANA', 'YASSIR'
  shippingAddress Json? // {street, city, postalCode, country, phone}
  shippingCost    Float?

  // Payment information
  paymentMethod   String? // 'STRIPE', 'COD', 'PAYPAL'
  stripeSessionId String?
  stripePaymentId String?
  paypalOrderId   String?

  // Shipment tracking
  trackingNumber String?
  shipmentStatus String    @default("PENDING_SHIPMENT") // PENDING_SHIPMENT, SHIPPED, IN_TRANSIT, DELIVERED
  shippedAt      DateTime?
  deliveredAt    DateTime?

  // Escrow & fund release
  buyerConfirmed Boolean   @default(false)
  confirmedAt    DateTime?
  fundsReleased  Boolean   @default(false)
  releasedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  review  Review?
  dispute Dispute?
  buyer   User    @relation("Buyer", fields: [buyerId], references: [id])
  listing Listing @relation(fields: [listingId], references: [id])
  seller  User    @relation("Seller", fields: [sellerId], references: [id])
}

model Dispute {
  id            String   @id @default(cuid())
  transactionId String   @unique
  reason        String   // 'NOT_RECEIVED', 'NOT_AS_DESCRIBED', 'DAMAGED'
  description   String
  status        String   @default("OPEN") // OPEN, RESOLVED_REFUND, RESOLVED_RELEASE, CANCELLED
  resolution    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

model Message {
  id         String   @id @default(cuid())
  content    String
  senderId   String
  receiverId String
  listingId  String?
  createdAt  DateTime @default(now())
  listing    Listing? @relation(fields: [listingId], references: [id])
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])

  // Offer fields
  type        String  @default("TEXT") // TEXT, OFFER
  offerAmount Float?
  offerStatus String? // PENDING, ACCEPTED, REJECTED

  // Notification fields
  read   Boolean   @default(false)
  readAt DateTime?
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  listing   Listing  @relation(fields: [listingId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, listingId])
}

model Review {
  id            String      @id @default(cuid())
  rating        Int
  comment       String?
  reviewerId    String
  revieweeId    String
  transactionId String      @unique
  createdAt     DateTime    @default(now())
  reviewee      User        @relation("Reviewee", fields: [revieweeId], references: [id])
  reviewer      User        @relation("Reviewer", fields: [reviewerId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

model Report {
  id          String   @id @default(cuid())
  reason      String
  description String?
  status      String   @default("PENDING")
  reporterId  String
  reportedId  String
  listingId   String?
  createdAt   DateTime @default(now())
  reporter    User     @relation("Reporter", fields: [reporterId], references: [id])
  reported    User     @relation("Reported", fields: [reportedId], references: [id])
  listing     Listing? @relation(fields: [listingId], references: [id])
}

model BlockedUser {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id])
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  type      String
  token     String   @unique
  code      String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}
